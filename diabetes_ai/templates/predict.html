{% extends "base.html" %}

{% block title %}Start Assessment - GlucoSense{% endblock %}

{% block extra_css %}
<style>
    /* Page-Specific Styles */
    .premium-form-container {
        max-width: 800px;
        margin: 0 auto 8rem;
        position: relative;
    }

    .form-header-premium {
        text-align: center;
        margin-bottom: 3rem;
    }

    .form-header-premium h2 {
        font-size: 2rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
    }

    .form-header-premium p {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    .form-section-premium {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
    }

    .form-section-premium:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .section-title-premium {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 1.5rem;
        background: var(--primary-soft);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-pill);
        width: fit-content;
    }

    .toggle-calculator {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
        transition: all 0.2s ease;
    }

    .toggle-calculator:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }

    /* Calculator Panel */
    .bmi-calculator-panel {
        display: none;
        background: var(--primary-soft);
        padding: 1.5rem;
        border-radius: var(--radius-md);
        margin-bottom: 2rem;
        border: 1px solid rgba(124, 58, 237, 0.1);
        animation: slideDown 0.3s var(--ease-bounce);
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .bmi-result-text {
        margin-top: 1rem;
        text-align: center;
        color: var(--primary);
        font-weight: 600;
    }

    /* Checkbox Styling */
    .checkbox-container {
        display: block;
        position: relative;
        padding-left: 35px;
        margin-bottom: 0;
        cursor: pointer;
        font-size: 0.95rem;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        color: var(--text-main);
    }

    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 22px;
        width: 22px;
        background-color: white;
        border: 2px solid #E5E7EB;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .checkbox-container:hover input~.checkmark {
        background-color: #F9FAFB;
        border-color: var(--primary-light);
    }

    .checkbox-container input:checked~.checkmark {
        background-color: var(--primary);
        border-color: var(--primary);
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    .checkbox-container input:checked~.checkmark:after {
        display: block;
    }

    .checkbox-container .checkmark:after {
        left: 7px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        -webkit-transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        transform: rotate(45deg);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header-premium">
    <div class="container">
        <h1 class="page-title">Health Assessment</h1>
        <p class="page-subtitle">Complete your profile for an AI-powered diabetes risk analysis.</p>
    </div>
</div>

<div class="container">
    <div class="premium-form-container">
        <form method="POST" action="{{ url_for('main.result') }}" class="glass-card" id="predictionForm">

            <div class="form-header-premium reveal">
                <h2>Your Health Profile</h2>
                <p>All fields are secure and confidential.</p>
            </div>

            <!-- SECTION 1: Personal Details -->
            <div class="form-section-premium reveal">
                <div class="section-title-premium">
                    <span>ðŸ‘¤</span> Personal Details
                </div>

                <div class="form-row">
                    <!-- Age -->
                    <div class="input-group">
                        <input type="number" name="age" id="age" class="input-pill" placeholder=" " min="1" max="120"
                            required>
                        <label for="age" class="input-label-floating">Age</label>
                        <span class="input-unit">years</span>
                        <!-- Icon -->
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                    </div>

                    <!-- Pregnancies -->
                    <div class="input-group">
                        <input type="number" name="pregnancies" id="pregnancies" class="input-pill" placeholder=" "
                            min="0" max="20" required>
                        <label for="pregnancies" class="input-label-floating">Pregnancies</label>
                        <span class="input-unit">count</span>
                        <span class="input-hint">0 for males/n.a.</span>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z">
                            </path>
                        </svg>
                    </div>
                </div>

                <!-- BMI Row -->
                <div class="form-row">
                    <div class="input-group">
                        <input type="number" Step="0.1" name="bmi" id="bmi" class="input-pill" placeholder=" " min="10"
                            max="70" required>
                        <label for="bmi" class="input-label-floating">BMI</label>
                        <span class="input-unit">kg/mÂ²</span>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z">
                            </path>
                        </svg>

                        <button type="button" class="toggle-calculator" onclick="toggleBMICalculator()"
                            style="position: absolute; right: 0; top: -30px;">
                            <span>ðŸ§® Calculate BMI</span>
                        </button>
                    </div>
                </div>

                <!-- BMI Calculator Layout -->
                <div id="bmiCalculator" class="bmi-calculator-panel">
                    <h4 style="margin-bottom: 1rem; color: var(--text-main);">BMI Calculator</h4>
                    <div class="form-row">
                        <div class="input-group" style="margin-bottom: 0;">
                            <input type="number" id="weight" class="input-pill" placeholder=" ">
                            <label class="input-label-floating">Weight (kg)</label>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <input type="number" id="height" class="input-pill" placeholder=" ">
                            <label class="input-label-floating">Height (cm)</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="calculateBMI()"
                        style="width: 100%; margin-top: 1rem;">Calculate & Auto-Fill</button>
                    <div id="bmiResult" class="bmi-result-text"></div>
                </div>
            </div>

            <!-- SECTION 2: Clinical Metrics -->
            <div class="form-section-premium reveal">
                <div class="section-title-premium">
                    <span>ðŸ©¸</span> Health & Clinical Metrics
                </div>

                <div class="form-row">
                    <!-- Glucose -->
                    <div class="input-group">
                        <input type="number" name="glucose" id="glucose" class="input-pill" placeholder=" " min="0"
                            max="300" required>
                        <label for="glucose" class="input-label-floating">Blood Sugar (Glucose)</label>
                        <span class="input-unit">mg/dL</span>
                        <span class="input-hint">Plasma glucose (typically 70-140 mg/dL)</span>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18.6 18.6L12 12V2.5"></path>
                            <circle cx="12" cy="12" r="10"></circle>
                        </svg>
                    </div>

                    <!-- Blood Pressure -->
                    <div class="input-group">
                        <input type="number" name="blood_pressure" id="blood_pressure" class="input-pill"
                            placeholder=" " min="0" max="200" required>
                        <label for="blood_pressure" class="input-label-floating">Blood Pressure</label>
                        <span class="input-unit">mm Hg</span>
                        <span class="input-hint">Diastolic (the <b>lower</b> number, e.g. 80)</span>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                    </div>
                </div>

                <div class="form-row">
                    <!-- Insulin -->
                    <div class="input-group">
                        <input type="number" name="insulin" id="insulin" class="input-pill" placeholder=" " min="0"
                            max="900" required>
                        <label for="insulin" class="input-label-floating">Insulin Level</label>
                        <span class="input-unit">Î¼U/mL</span>
                        <span class="input-hint">2-Hour serum insulin (Can be 0 if unknown)</span>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 14l-7 7-7-7"></path>
                            <path d="M12 19V5"></path>
                        </svg>
                    </div>

                    <!-- Skin Thickness -->
                    <div class="input-group">
                        <input type="number" name="skin_thickness" id="skin_thickness" class="input-pill"
                            placeholder=" " min="0" max="100" required>
                        <label for="skin_thickness" class="input-label-floating">Body Fat (Skinfold)</label>
                        <span class="input-unit">mm</span>
                        <span class="input-hint">Triceps skin thickness (Can be 0 if unknown)</span>
                        <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                        </svg>
                    </div>
                </div>

                <!-- Family History (Replaces Pedigree Function) -->
                <div class="input-group">
                    <input type="number" step="0.001" name="diabetes_pedigree" id="diabetes_pedigree" class="input-pill"
                        placeholder=" " min="0" max="3" required>
                    <label for="diabetes_pedigree" class="input-label-floating">Family History Score</label>
                    <span class="input-unit">score</span>
                    <span class="input-hint">AI-calculated genetic risk score (typically 0.1 - 2.5)</span>
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>

                    <button type="button" class="toggle-calculator" onclick="toggleHistoryCalculator()"
                        style="position: absolute; right: 0; top: -30px;">
                        <span>ðŸ§¬ Calculate History Score</span>
                    </button>
                </div>

                <!-- Family History Calculator Layout -->
                <div id="historyCalculator" class="bmi-calculator-panel" style="margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--text-main);">Family Diabetes History</h4>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem;">
                        Select biological relatives who have been diagnosed with diabetes.
                    </p>

                    <div class="history-grid"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <label class="checkbox-container">
                            <input type="checkbox" id="hist_mother"> Mother
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="hist_father"> Father
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="hist_sibling"> Sibling(s)
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="hist_grandparent"> Grandparent(s)
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="hist_aunt_uncle"> Aunt / Uncle
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-container">
                            <input type="checkbox" id="hist_cousin"> First Cousin
                            <span class="checkmark"></span>
                        </label>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="calculateHistoryScore()"
                        style="width: 100%;">Apply Assessment</button>
                    <div id="historyResult" class="bmi-result-text" style="margin-top: 1rem; font-size: 0.9rem;"></div>
                </div>
            </div>

            <!-- Trust / Info -->
            <div class="info-box-premium">
                <div class="info-icon">ðŸ”’</div>
                <div class="info-content">
                    <strong>Secure & Private Analysis</strong>
                    <p>Your data is processed in real-time and never stored permanently. If you are unsure of any value
                        (like Insulin), zero is accepted.</p>
                </div>
            </div>

            <!-- Submit -->
            <div class="form-submit-container">
                <button type="submit" class="btn btn-primary btn-submit"
                    style="padding: 1.25rem 4rem; font-size: 1.1rem; border-radius: 99px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 0.5rem;">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Analyze Risk Now
                </button>
            </div>

            <!-- Badges -->
            <div class="trust-badges" style="margin-top: 2rem; justify-content: center;">
                <div class="trust-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                    </svg> HIPAA Compliant
                </div>
                <div class="trust-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg> Private
                </div>
            </div>

        </form>
    </div>
</div>

<script>
    // BMI Logic
    function toggleBMICalculator() {
        const panel = document.getElementById('bmiCalculator');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function calculateBMI() {
        const w = parseFloat(document.getElementById('weight').value);
        const h = parseFloat(document.getElementById('height').value);
        if (!w || !h) { alert('Please enter weight and height'); return; }

        const bmi = (w / ((h / 100) ** 2)).toFixed(1);
        document.getElementById('bmi').value = bmi;

        // Trigger visual update for floating label
        document.getElementById('bmi').dispatchEvent(new Event('input'));

        let msg = '';
        let color = '#7C3AED';
        if (bmi < 18.5) { msg = 'Underweight'; color = '#F59E0B'; }
        else if (bmi < 25) { msg = 'Normal Weight'; color = '#10B981'; }
        else if (bmi < 30) { msg = 'Overweight'; color = '#F59E0B'; }
        else { msg = 'Obese'; color = '#EF4444'; }

        document.getElementById('bmiResult').innerHTML = `<span style="color: ${color}"><strong>Score: ${bmi}</strong> â€” ${msg}</span>`;
    }

    // History Logic
    function toggleHistoryCalculator() {
        const panel = document.getElementById('historyCalculator');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function calculateHistoryScore() {
        let score = 0.1; // Baseline

        if (document.getElementById('hist_mother').checked) score += 0.45;
        if (document.getElementById('hist_father').checked) score += 0.45;
        if (document.getElementById('hist_sibling').checked) score += 0.35;
        if (document.getElementById('hist_grandparent').checked) score += 0.2;
        if (document.getElementById('hist_aunt_uncle').checked) score += 0.15;
        if (document.getElementById('hist_cousin').checked) score += 0.1;

        // Add some "random" genetic variance for realism (0-0.05)
        score += Math.random() * 0.05;

        const finalScore = score.toFixed(3);
        document.getElementById('diabetes_pedigree').value = finalScore;

        // Trigger visual update
        document.getElementById('diabetes_pedigree').dispatchEvent(new Event('input'));

        let riskLabel = "";
        let riskColor = "";
        if (score < 0.3) { riskLabel = "Low Genetic Risk"; riskColor = "#10B981"; }
        else if (score < 0.8) { riskLabel = "Moderate Genetic Risk"; riskColor = "#F59E0B"; }
        else { riskLabel = "High Genetic Risk"; riskColor = "#EF4444"; }

        document.getElementById('historyResult').innerHTML = `<span style="color: ${riskColor}"><strong>Calculated Score: ${finalScore}</strong><br>${riskLabel}</span>`;
    }

    // Input Visuals
    document.querySelectorAll('.input-pill').forEach(input => {
        input.addEventListener('input', function () {
            if (this.value) this.style.borderColor = 'var(--primary)';
            else this.style.borderColor = '';
        });
    });
</script>
{% endblock %}